<div class="container mx-auto my-8 p-4 bg-white rounded-lg shadow-lg">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Dossier Médical : {{ membre.username|title }}</h2>
        
        <!-- Bouton visible uniquement pour les médecins -->
        {% if user.user_type == 'medecin' %}
        <button id="add-consultation-button" class="bg-purple-600 text-white py-2 px-4 rounded-lg shadow hover:bg-purple-700 transition duration-200">
            Ajouter une historique de consultation
        </button>
        {% endif %}
    </div>

    <!-- Tableau des consultations -->
    <div class="flex flex-wrap">
        <div class="w-full overflow-x-auto">
            <table class="table-auto w-full text-left border-collapse">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-2 md:px-4 py-2 border">Date</th>
                        <th class="px-2 md:px-4 py-2 border">Docteur</th>
                        <th class="px-2 md:px-4 py-2 border">Établissement</th>
                        <th class="px-2 md:px-4 py-2 border">Symptômes</th>
                        <th class="px-2 md:px-4 py-2 border">Diagnostic</th>
                        <th class="px-2 md:px-4 py-2 border">Prescriptions</th>
                        <th class="px-2 md:px-4 py-2 border">Traitements</th>
                    </tr>
                </thead>
                <tbody>
                    {% for consultation in consultations %}
                    <tr class="hover:bg-gray-100">
                        <td class="px-2 md:px-4 py-2 border">{{ consultation.date|date:"d F Y" }}</td>
                        <td class="px-2 md:px-4 py-2 border">{{ consultation.doctor.username }}</td>
                        <td class="px-2 md:px-4 py-2 border">{{ consultation.establishment }}</td>
                        <td class="px-2 md:px-4 py-2 border">{{ consultation.symptoms }}</td>
                        <td class="px-2 md:px-4 py-2 border">{{ consultation.diagnosis }}</td>
                        <td class="px-2 md:px-4 py-2 border">{{ consultation.prescriptions }}</td>
                        <td class="px-2 md:px-4 py-2 border">{{ consultation.treatments }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4">Aucune consultation trouvée.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Fenêtre modale pour ajouter une consultation -->
<div id="add-consultation-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75  justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-3/4 md:w-1/2 lg:w-1/3 p-6">
        <h3 class="text-xl font-bold mb-4">Ajouter une Consultation</h3>
        <form id="add-consultation-form" method="post">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-gray-700">Date de Consultation</label>
                <input type="date" name="date" class="w-full border border-gray-300 rounded-md p-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700">Établissement</label>
                <input type="text" name="establishment" class="w-full border border-gray-300 rounded-md p-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700">Symptômes</label>
                <textarea name="symptoms" class="w-full border border-gray-300 rounded-md p-2" required></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700">Diagnostic</label>
                <textarea name="diagnosis" class="w-full border border-gray-300 rounded-md p-2" required></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700">Prescriptions</label>
                <textarea name="prescriptions" class="w-full border border-gray-300 rounded-md p-2"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700">Traitements</label>
                <textarea name="treatments" class="w-full border border-gray-300 rounded-md p-2"></textarea>
            </div>
            <div class="flex justify-end">
                <button type="button" id="cancel-button" class="mr-4 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg py-2 px-4">Annuler</button>
                <button type="submit" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200">Ajouter</button>
            </div>
        </form>
    </div>
</div>

<script>
    const addConsultationButton = document.getElementById('add-consultation-button');
    const modal = document.getElementById('add-consultation-modal');
    const cancelButton = document.getElementById('cancel-button');

    addConsultationButton.addEventListener('click', () => {
        modal.classList.remove('hidden');
    });

    cancelButton.addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    const addConsultationForm = document.getElementById('add-consultation-form');

    addConsultationForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Empêche le rechargement de la page

        const formData = new FormData(addConsultationForm);
        const memberId = "{{ membre.id }}";

        fetch(`/dossier-medical/${memberId}/add-consultation/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                // Ferme la fenêtre modale
                modal.classList.add('hidden');
                // Recharge la page pour afficher la nouvelle consultation
                window.location.reload();
            }
        })
        .catch(error => console.error('Erreur:', error));
    });

    addConsultationButton.addEventListener('click', () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex'); // Ajouter flex ici pour afficher le modal correctement
    });
    
    cancelButton.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex'); // Supprimer flex pour masquer le modal
    });
    
</script>
