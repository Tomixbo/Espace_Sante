{% load static %}
{% load custom_tags %}
<div id="schedule-container" class="container mx-auto p-4"
     data-is-doctor="{{ user_is_doctor|yesno:'true,false' }}"
     data-csrf-token="{{ csrf_token }}"
     data-user-id="{{ user.id }}">
    <!-- Navigation -->
    {% with first_day=week_days.0 last_day=week_days|last %}
        <h1 class="font-bold text-center adaptive-text-title mb-2 flex-1 px-10">
            Planning des Consultations ({{ first_day.display }} - {{ last_day.display }})
        </h1>
    {% endwith %}
    <div class="flex flex-wrap justify-between items-center mb-4">
        <a href="#" id="prev-week" data-week-offset="{{ week_offset|add:-1 }}" class="text-blue-500 hover:text-blue-700 adaptive-text mb-2">&larr; Semaine Précédente</a>
        <a href="#" id="next-week" data-week-offset="{{ week_offset|add:1 }}" class="text-blue-500 hover:text-blue-700 adaptive-text mb-2">Semaine Suivante &rarr;</a>
    </div>

    <!-- Vue Tableau -->
    <div id="table-view" class="overflow-x-auto">
        <table class="min-w-full bg-white border">
            <thead>
                <tr>
                    <th class="border px-4 py-2 text-center adaptive-text"></th> <!-- Empty cell for hour labels -->
                    {% for day in week_days %}
                        <th class="border px-4 py-2 text-center adaptive-text">{{ day.display }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hour in hours %}
                    <tr>
                        <td class="border px-4 py-2 text-center font-bold adaptive-text">{{ hour }}</td>
                        {% for day in week_days %}
                            {% with consultation=consultations_by_day|get_item:day.display|get_item:hour %}
                                {% if consultation %}
                                    <td class="border px-4 py-2 text-center bg-green-500 text-white hover:bg-green-600 cursor-pointer adaptive-text"
                                        data-consultation-id="{{ consultation.id }}"
                                        data-consultation-doctor="{{ consultation.doctor.username }}"
                                        data-consultation-patient="{{ consultation.patient.username }}"
                                        data-consultation-facility="{{ consultation.facility }}"
                                        data-consultation-start="{{ consultation.consultation_start_time|date:'Y-m-d\TH:i:s' }}"
                                        data-consultation-end="{{ consultation.consultation_end_time|date:'Y-m-d\TH:i:s' }}">
                                        {{ consultation.doctor.username }} - {{ consultation.patient.username }}
                                    </td>
                                {% else %}
                                    <td class="border px-4 py-2 text-center bg-white hover:bg-gray-200 cursor-pointer relative adaptive-text"
                                        data-date="{{ day.date|date:'Y-m-d' }}" data-hour="{{ hour }}">
                                        <span class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300 adaptive-text">Réserver</span>
                                    </td>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Vue Liste par Jour -->
    <div id="list-view" class="space-y-2 h-[calc(60vh)] overflow-y-auto">
        {% for day in week_days %}
            <div class="mb-6">
                <h2 class="text-lg font-bold mb-4 adaptive-text">{{ day.display }}</h2>
                <div class="space-y-2">
                    {% for hour in hours %}
                        {% with consultation=consultations_by_day|get_item:day.display|get_item:hour %}
                            {% if consultation %}
                                <div class="border p-4 bg-green-500 text-white hover:bg-green-600 cursor-pointer adaptive-text"
                                    data-consultation-id="{{ consultation.id }}"
                                    data-consultation-doctor="{{ consultation.doctor.username }}"
                                    data-consultation-patient="{{ consultation.patient.username }}"
                                    data-consultation-facility="{{ consultation.facility }}"
                                    data-consultation-start="{{ consultation.consultation_start_time|date:'Y-m-d\TH:i:s' }}"
                                    data-consultation-end="{{ consultation.consultation_end_time|date:'Y-m-d\TH:i:s' }}">
                                    <p class="font-bold adaptive-text">{{ hour }}</p>
                                    <p class="adaptive-text">{{ consultation.doctor.username }} - {{ consultation.patient.username }}</p>
                                </div>
                            {% else %}
                                <div class="border p-4 bg-white hover:bg-gray-200 cursor-pointer relative adaptive-text"
                                    data-date="{{ day.date|date:'Y-m-d' }}" data-hour="{{ hour }}">
                                    <p class="font-bold adaptive-text">{{ hour }}</p>
                                    <p class="adaptive-text">Disponible</p>
                                    <span class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300 adaptive-text">Réserver</span>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Modal for consultation details -->
    <div id="consultation-modal" class="fixed z-10 inset-0 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 text-center">
            <div class="bg-white rounded-lg p-6 shadow-lg max-w-lg w-full">
                <h2 class="text-2xl font-bold mb-4">Détails de la Consultation</h2>
                <p id="modal-start-time" class="text-lg font-semibold mb-2"></p>
                <p><strong>Docteur:</strong> <span id="modal-doctor"></span></p>
                <p><strong>Patient:</strong> <span id="modal-patient"></span></p>
                <p><strong>Lieu:</strong> <span id="modal-facility"></span></p>
                <button id="close-modal" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal for booking a consultation -->
    <div id="booking-modal" class="fixed z-10 inset-0 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 text-center">
            <div class="bg-white rounded-lg p-6 shadow-lg max-w-lg w-full">
                <h2 class="text-2xl font-bold mb-4">Créer une Consultation</h2>
                <p><strong>Date:</strong> <span id="modal-date"></span></p>
                <p><strong>Heure:</strong> <span id="modal-hour"></span></p>
                <div id="user-selection"></div>
                <button id="confirm-booking" class="mt-4 bg-green-500 text-white px-4 py-2 rounded">Confirmer</button>
                <button id="close-modal-booking" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">Fermer</button>
            </div>
        </div>
    </div>
    <!-- Hidden elements for patient and doctor selection -->
    <div id="hidden-elements" style="display: none;">
        <div id="patient-selection">
            <label for="patient">Sélectionner un patient:</label>
            <select id="patient">
                {% for patient in patients %}
                    <option value="{{ patient.id }}">{{ patient.username }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="doctor-selection">
            <label for="doctor">Sélectionner un docteur:</label>
            <select id="doctor">
                {% for doctor in doctors %}
                    <option value="{{ doctor.id }}">{{ doctor.username }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

</div> <!-- Fermeture du schedule-container -->

<!-- Inclure le fichier JavaScript du planning -->
<script src="{% static 'js/planning.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initializePlanningContent();
    });
</script>