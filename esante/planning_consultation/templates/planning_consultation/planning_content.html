{% load custom_tags %}
<div class="container mx-auto my-8 p-4">
    <div class="flex justify-between mb-4">
        <a href="?week={{ week_offset|add:-1 }}" class="text-blue-500 hover:text-blue-700">&larr; Semaine Précédente</a>
        {% with first_day=week_days.0 last_day=week_days|last %}
            <h1 class="text-xl font-bold">
                Planning des Consultations ({{ first_day.display }} - {{ last_day.display }})
            </h1>
        {% endwith %}
        <a href="?week={{ week_offset|add:1 }}" class="text-blue-500 hover:text-blue-700">Semaine Suivante &rarr;</a>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border">
            <thead>
                <tr>
                    <th class="border px-4 py-2 text-center"></th> <!-- Empty cell for hour labels -->
                    {% for day in week_days %}
                        <th class="border px-4 py-2 text-center">{{ day.display }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hour in hours %}
                    <tr>
                        <td class="border px-4 py-2 text-center font-bold">{{ hour }}</td>
                        {% for day in week_days %}
                            {% with consultation=consultations_by_day|get_item:day.display|get_item:hour %}
                                {% if consultation %}
                                    <td class="border px-4 py-2 text-center bg-green-500 text-white hover:bg-green-600 cursor-pointer" 
                                        data-consultation-id="{{ consultation.id }}">
                                        {{ consultation.doctor.username }} - {{ consultation.patient.username }}
                                    </td>
                                {% else %}
                                    <td class="border px-4 py-2 text-center bg-white hover:bg-gray-200 cursor-pointer relative"
                                        data-date="{{ day.date|date:'Y-m-d' }}" data-hour="{{ hour }}">
                                        <span class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300">Réserver</span>
                                    </td>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Modal for consultation details -->
    <div id="consultation-modal" class="fixed z-10 inset-0 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 text-center">
            <div class="bg-white rounded-lg p-6 shadow-lg max-w-lg w-full">
                <h2 class="text-2xl font-bold mb-4">Détails de la Consultation</h2>
                <p id="modal-start-time" class="text-lg font-semibold mb-2"></p>
                <p><strong>Docteur:</strong> <span id="modal-doctor"></span></p>
                <p><strong>Patient:</strong> <span id="modal-patient"></span></p>
                <p><strong>Lieu:</strong> <span id="modal-facility"></span></p>
                <button id="close-modal" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal for booking a consultation -->
    <div id="booking-modal" class="fixed z-10 inset-0 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 text-center">
            <div class="bg-white rounded-lg p-6 shadow-lg max-w-lg w-full">
                <h2 class="text-2xl font-bold mb-4">Créer une Consultation</h2>
                <p><strong>Date:</strong> <span id="modal-date"></span></p>
                <p><strong>Heure:</strong> <span id="modal-hour"></span></p>
                <div id="user-selection"></div>
                <button id="confirm-booking" class="mt-4 bg-green-500 text-white px-4 py-2 rounded">Confirmer</button>
                <button id="close-modal-booking" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Data containing the consultations
    const consultations = {{ consultations_json|safe }};
    const isDoctor = {{ user_is_doctor|yesno:'true,false' }}; // Check if the user is a doctor or patient

    // Show consultation modal when clicking on an existing consultation
    document.querySelectorAll('[data-consultation-id]').forEach(td => {
        td.addEventListener('click', function() {
            const consultation = consultations.find(c => c.id == this.dataset.consultationId);
            
            if (consultation) {
                // Format the date and time
                const consultationDate = new Date(consultation.consultation_start_time).toLocaleDateString('fr-FR', {
                    timeZone: 'Indian/Antananarivo',  // Spécifie le fuseau horaire de Madagascar
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const startTime = new Date(consultation.consultation_start_time).toLocaleTimeString('fr-FR', {
                    timeZone: 'Indian/Antananarivo',  // Spécifie le fuseau horaire de Madagascar
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(':00', 'h');

                const endTime = new Date(consultation.consultation_end_time).toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(':00', 'h');

                const formattedDateTime = `${consultationDate}, de ${startTime} à ${endTime}`;

                // Display the formatted date and time
                document.getElementById('modal-start-time').textContent = formattedDateTime;

                // Display the doctor, patient, and facility
                document.getElementById('modal-doctor').textContent = consultation.doctor;
                document.getElementById('modal-patient').textContent = consultation.patient;
                document.getElementById('modal-facility').textContent = consultation.facility;

                document.getElementById('consultation-modal').classList.remove('hidden');
            }
        });
    });

    // Handle empty slot clicks for creating a consultation
    document.querySelectorAll('[data-date]').forEach(td => {
        td.addEventListener('click', function() {
            const date = this.dataset.date;  // Now correctly populated
            const hour = this.dataset.hour;

            document.getElementById('modal-date').textContent = date;  // Set the date in the modal
            document.getElementById('modal-hour').textContent = hour;
    
            let selectionHTML = '';
    
            if (isDoctor) {
                selectionHTML = `
                    <label for="patient">Sélectionner un patient:</label>
                    <select id="patient">
                        {% for patient in patients %}
                            <option value="{{ patient.id }}">{{ patient.username }}</option>
                        {% endfor %}
                    </select>
                `;
            } else {
                selectionHTML = `
                    <label for="doctor">Sélectionner un docteur:</label>
                    <select id="doctor">
                        {% for doctor in doctors %}
                            <option value="{{ doctor.id }}">{{ doctor.username }}</option>
                        {% endfor %}
                    </select>
                `;
            }
    
            document.getElementById('user-selection').innerHTML = selectionHTML;
            document.getElementById('booking-modal').classList.remove('hidden');
        });
    });
    

    // Close modals
    document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('consultation-modal').classList.add('hidden');
    });

    document.getElementById('close-modal-booking').addEventListener('click', function() {
        document.getElementById('booking-modal').classList.add('hidden');
    });

    // Confirm booking
document.getElementById('confirm-booking').addEventListener('click', function() {
    const date = document.getElementById('modal-date').textContent;  // Should be 'YYYY-MM-DD'
    const hour = document.getElementById('modal-hour').textContent;  // 'HHh - HHh' format

    let userSelection = '';

    if (isDoctor) {
        userSelection = document.getElementById('patient').value;
    } else {
        userSelection = document.getElementById('doctor').value;
    }

    // Parse the start and end time from the hour range
    const startHour = hour.split(' - ')[0].replace('h', '');  // E.g., '9h' becomes '9'
    const endHour = hour.split(' - ')[1].replace('h', '');    // E.g., '10h' becomes '10'

    // Pad hours to ensure two digits
    const startHourPadded = startHour.padStart(2, '0');
    const endHourPadded = endHour.padStart(2, '0');

    // Construct valid datetime strings
    const consultation_start_time = `${date}T${startHourPadded}:00:00`;  // 'YYYY-MM-DDTHH:00:00'
    const consultation_end_time = `${date}T${endHourPadded}:00:00`;      // 'YYYY-MM-DDTHH:00:00'

    // Send the data to the server
    fetch('/create-consultation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            doctor: isDoctor ? '{{ user.id }}' : userSelection,
            patient: isDoctor ? userSelection : '{{ user.id }}',
            consultation_start_time: consultation_start_time,
            consultation_end_time: consultation_end_time,
            facility: 'Online'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('booking-modal').classList.add('hidden');
            location.reload();
        } else {
            alert('Erreur lors de la réservation: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Une erreur s\'est produite.');
    });
});


    
    
</script>